---
title: Image
cover: ../assets/images/default.jpg
excerpt: é€™å€‹ç« ç¯€ï¼Œæœƒæ•™ä½ å¦‚ä½•é€é Dockerfile build imageï¼Œä¹Ÿæœƒæ•™ä½ æ›´å¤šé—œæ–¼ image çš„çŸ¥è­˜
date: 2019-12-18
author: Justin
readingTime: 5
type: docker
---

åœ¨é€™å€‹ç« ç¯€ï¼Œé™¤äº†æœƒæ•™ä½ å¦‚ä½•é€é Dockerfile build image å¤–ï¼Œä¹Ÿæœƒæ•™ä½ æ›´å¤šé—œæ–¼ image çš„çŸ¥è­˜ï¼Œé‚£æˆ‘å€‘å°±é–‹å§‹å§ï¼

## image layer

image å¯ä»¥è¢«åˆ†è§£ç‚ºæ•¸å±¤ layerï¼Œæ¯å±¤ layer éƒ½å°æ‡‰åˆ° Dockerfile çš„å…¶ä¸­ä¸€è¡ŒæŒ‡ä»¤ï¼Œlayer æœ‰å„è‡ªä¸åŒçš„å¤§å°åŠ IDï¼Œä¸‹é¢æ˜¯ä¸€å€‹ Dockerfile èˆ‡ä»–çš„ layer ç¤ºæ„åœ–

```
FROM ubuntu:15.04
COPY . /app
RUN make /app
CMD python /app/app.py
```

![layer](../assets/images/docker/layer.png)

å¾åœ–ä¸­ä½ å¯ä»¥çœ‹åˆ°å¹¾ä»¶äº‹

- container å¯ä»¥è¦–ç‚ºä¸€å€‹ layer åŠ åœ¨åŸå…ˆçš„ image ä¹‹ä¸Š
- image layer æ˜¯ read-only çš„ï¼Œä½† container layer æ˜¯å¯è®€å¯«çš„

çœ‹åˆ°é€™ä½ å¯èƒ½æœƒæƒ³å• layer çš„ç”¨é€”åˆ°åº•æ˜¯ä»€éº¼ï¼Ÿç‚ºä»€éº¼æˆ‘å€‘éœ€è¦ layerï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼šlayer çš„è¨­è¨ˆæé«˜äº† image éƒ¨ä»½å…§å®¹çš„å¯é‡ç”¨æ€§ã€‚é€™æ˜¯ä»€éº¼æ„æ€å‘¢ï¼Ÿå‡è¨­ä½ ä»Šå¤© pull ä¸€å€‹ä»¥é€™å€‹ Dockerfile build å‡ºä¾†çš„ image

```
FROM ubuntu:16.04
COPY . /app
# ä»¥ä¸‹çœç•¥
```

åŒæ™‚ä¹Ÿ pull ä»¥å¦ä¸€å€‹ Dockerfile build å‡ºä¾†çš„ image

```
FROM ubuntu:16.04
# ä»¥ä¸‹çœç•¥
```

åœ¨ pull image æ™‚ docker æœƒä¸€å€‹ layer ä¸€å€‹ layer çš„ä¸‹è¼‰ï¼Œæ­¤æ™‚

- å¦‚æœå®ƒé‡åˆ°æ“æœ‰æ–° ID çš„ layerï¼Œä¹Ÿå°±æ˜¯å®ƒä»¥å‰æ²’çœ‹éçš„æŒ‡ä»¤çš„è©±ï¼Œä»–æœƒå°‡é€™çµ„ layer ä¸‹è¼‰ä¸¦å­˜èµ·ä¾†
- å¦‚æœå®ƒé‡åˆ°å®ƒæ›¾ç¶“ä¸‹è¼‰éçš„ layerï¼Œå®ƒæœƒç›´æ¥è·³éï¼Œä¸æœƒå†ä¸‹è¼‰ä¸€æ¬¡

æ‰€ä»¥å›åˆ°ä¸Šé¢çš„ä¾‹å­ï¼Œé€™å…©å€‹ image çš„å…§å®¹éƒ½æœ‰ `FROM ubuntu:16.04`ï¼Œç”±é€™å¥æŒ‡ä»¤å‰µé€ å‡ºçš„ layer æœƒæœ‰ç›¸åŒçš„ IDï¼Œå› æ­¤ docker åœ¨ pull ç¬¬äºŒå€‹ image æ™‚å…¶å¯¦ä¸æœƒå†ä¸‹è¼‰ä¸€æ¬¡ `FROM ubuntu:16.0`é€™å€‹ layerã€‚ä¹‹å¾Œç•¶ä»¥ç¬¬äºŒå€‹ image ç‚ºåŸºåº•çš„ container è¦å»ºç«‹æ™‚ï¼Œæœƒèˆ‡ä»¥ç¬¬ä¸€å€‹ image ç‚ºåŸºåº•çš„ container å…±ç”¨åŒä¸€å±¤ layer

é€™ä»£è¡¨ï¼Œé‡å°åŒä¸€ç¨® layerï¼Œdocker åªæœƒåœ¨ä½ çš„é›»è…¦å­˜ä¸€æ¬¡ï¼Œæ¸›å°‘ image çš„ä¸‹è¼‰æ™‚é–“ä»¥åŠå­˜å„²ç©ºé–“

![layer2](../assets/images/docker/layer2.png)

é€™å€‹ testnode æ˜¯ç”± nginx é€™å€‹ image å†åŠ ä¸€äº›æ±è¥¿ build å‡ºä¾†çš„ï¼Œæ‰€ä»¥ä½ æœƒç™¼ç¾å¾ˆå¤š layer éƒ½é¡¯ç¤ºã€ŒAlready existsã€ï¼Œä»£è¡¨é€™äº› layer ä½ éƒ½ä¸ç”¨ä¸‹è¼‰äº† ğŸ˜„

## CoW

image è¨­è¨ˆæˆ read-only æ˜¯å°ä½ å¥½çš„ï¼Œå› ç‚ºä½ ä¸æœƒå¸Œæœ›ä»¥åŒä¸€å€‹ image run å‡ºçš„ container è¡Œç‚ºä¸ä¸€æ¨£ï¼Œå¦‚æœä½ æƒ³æ–°å¢æˆ–ä¿®æ”¹ä¸€äº›æ±è¥¿ï¼Œå¯ä»¥åŠ åœ¨ container layer è£¡

æ‰€è¬‚çš„ CoWï¼ˆcopy-on-writeï¼‰ æ˜¯ä¸€å€‹ç•¶ä½ åœ¨ container å°æŸå€‹æª”æ¡ˆåšä¿®æ”¹æ™‚å°‡ä½¿ç”¨çš„ç­–ç•¥ï¼Œä¸»è¦æœƒä¾åºé€²è¡Œä»¥ä¸‹å¹¾ä»¶äº‹ï¼š

1. å¾ä¸Šå±¤ layer å¾€ä¸‹å±¤å°‹æ‰¾é‚£å€‹å³å°‡è¢«æ›´æ–°çš„æª”æ¡ˆçš„ä½ç½®ï¼Œç•¶é€™å€‹æª”æ¡ˆè¢«æ‰¾åˆ°æ™‚ï¼ŒæœƒåŠ å…¥åˆ° cache ä¸­ï¼Œä¾›æœªä¾†ä½¿ç”¨
2. åŸ·è¡Œ copy_up æ“ä½œï¼Œå°‡å‰›å‰›æ‰¾åˆ°çš„æª”æ¡ˆåŠ å…¥åˆ° container layer
3. å°é€™å€‹æª”æ¡ˆçš„ä»»ä½•ä¿®æ”¹éƒ½åªæœƒåšåœ¨ container layer ä¸­

é€é CoWï¼Œä½ çš„ image å°‡å¯ä»¥ä¿æŒä¸è®Šæ€§

## Build image

åªè¦ä½ æº–å‚™å¥½ dockerfileï¼Œbuild image çš„éç¨‹å°±éå¸¸ç°¡å–®ï¼Œåªéœ€è¦ä¸‹ä¸€å€‹æŒ‡ä»¤

```
docker image build -t nodeapp .
```

ä¸Šé¢çš„æ„æ€ä»£è¡¨ä½ è¦å¾ç•¶å‰ç›®éŒ„æ‰¾ Dockerfileï¼Œç„¶å¾Œ build å‡ºä¸€å€‹åç‚º nodeapp çš„ image

å¦‚æœä½ çš„ Dockerfile ä¸å« Dockerfileï¼Œä½ å¯ä»¥é€™æ¨£ä¸‹

```
docker image build -f Dockerfile.dev -t nodeapp .
```

ä¹‹å¾Œä½ å¯ä»¥é€é `docker image ls` çœ‹åˆ°ä½  build å¥½çš„ image

## æ¨é€ image åˆ° docker hub

æœ‰äº†è‡ªå·±çš„ image å¾Œï¼Œä½ å¯ä»¥ push åˆ° docker hub äº†ï¼æ­¥é©Ÿå¦‚ä¸‹ï¼š

### 1. é€²è¡Œ image retag

ä½ å¿…é ˆåœ¨ image å‰é¢åŠ ä¸Šä½ çš„ usernameï¼Œä½œç‚º namespace

```
docker image tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]
```

### 2. push!

```
docker push TARGET_IMAGE[:TAG]
```

è¨˜å¾— push å‰å¯èƒ½è¦å…ˆç”¨æŒ‡ä»¤ç™»å…¥ä¸€ä¸‹ docker å“¦

## å¿«é€Ÿç·´ç¿’

1. è§£é‡‹ä¸€ä¸‹ image layer çš„æ¦‚å¿µä»¥åŠä»–çš„ä½œç”¨

åƒè€ƒè§£ç­”

1. [About images, containers, and storage drivers | Docker Documentation](https://docs.docker.com/v17.09/engine/userguide/storagedriver/imagesandcontainers/)

#Docker
